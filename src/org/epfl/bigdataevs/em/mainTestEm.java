package org.epfl.bigdataevs.em;

import org.apache.commons.math3.fraction.BigFraction;
import org.apache.spark.api.java.JavaPairRDD;
import org.apache.spark.api.java.JavaRDD;
import org.apache.spark.api.java.JavaSparkContext;
import org.epfl.bigdataevs.eminput.TimePeriod;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

public class mainTestEm{
  public static void main(String[] args) {
    Date start = new Date(2014, 1, 1);
    Date end = new Date(2015, 1, 1);
    
    
    String article1 = "Dans ce texte remis à François Hollande ce mercredi, le président de l'Assemblée nationale juge par ailleurs que «le sentiment d'appartenance républicaine» n'est lié ni au mode d'acquisition de la nationalité, ni à la religion. Contrairement au président du Sénat, Gérard Larcher (UMP), qui a remis mercredi un rapport sur le même thème au chef de l'Etat, Claude Bartolone n'aborde pas la question de l'organisation des cultes. Lors des auditions et déplacements qu'il a effectués, relève-t-il, «le sujet des appartenances religieuses, des origines familiales ou de l'actualité de la loi de 1905 (sur la laïcité) n'est jamais apparu spontanément». «Réaffirmer le sentiment d'appartenance républicaine par la citoyenneté, c'est aussi redire que ce n'est pas une question de modalités d'acquisition de la nationalité, que ce n'est pas non plus une question d'origine ou cultuelle», écrit-il. Si certains sont à l'écart de ce sentiment d'appartenance, comme «les absents des marches des 10 et 11 janvier», ce n'est pas lié à «la religion des uns ou des autres» mais au fait «que notre République est aujourd'hui malade de phénomènes de repli, de cloisonnement, d'entre-soi». Dans son texte, Claude Bartolone rappelle que les députés socialistes avaient déposé en 2003 une proposition de loi pour le vote obligatoire. «Je soutiendrai comme il y a 12 ans cette proposition: la citoyenneté, c'est un droit mais c'est aussi un devoir».";
    String article2 = "C'était attendu, c'est officiel: Bruxelles accuse Google d'abus de position dominante dans les moteurs de recherche. Par ailleurs, la Commission européenne a aussi ouvert une enquête contre Google sur son système pour téléphone portable Android.. «Je crains que l'entreprise n'ait injustement avantagé son propre service de comparaison de prix, en violation des règles de l'UE en matière d'ententes et d'abus de position dominante», a déclaré la commissaire européenne chargée du dossier, Margrete Vestager. Concrètement, la Commission craint que les utilisateurs de Google, qui représente 90% des recherches sur l'internet dans la plupart des pays d'Europe, «ne voient pas nécessairement les résultats les plus pertinents en réponse à leurs requêtes».";
    String article3 = "C'est un évènement. Le président français François Hollande est attendu ce mercredi en Suisse pour une visite d'Etat de deux jours qui vise à relancer la relation avec Berne. Et ce, 17 ans après Jacques Chirac, dernier président français en date à s'être rendu en visite officielle chez le voisin helvétique. Paris entend ainsi tourner la page d'une série de brouilles sur les questions de l'évasion fiscale ou de l'aéroport de Bâle-Mulhouse mais aussi célébrer voire s'inspirer du «modèle» helvétique en matière de croissance verte ou d'apprentissage.  Après avoir accepté d'échanger, sur demande, les informations concernant les ressortissants français soupçonnés d'évasion fiscale par Bercy, Berne s'est engagé à rendre cet échange d'informations automatique à compter de 2018. A son arrivée sur le sol helvétique où il est attendu vers 14h, François Hollande, accompagné de six membres du gouvernement (Ecologie, Education, Finances, Travail, Affaires européennes et Numérique) sera accueilli par la présidente en exercice de la Confédération, Simonetta Sommarruga. Tous deux s'exprimeront ensuite à l'hôtel de ville de Berne avant de se retrouver pour un entretien et de tenir une conférence de presse conjointe. Un « dîner d\'Etat » les réunira une nouvelle fois dans la soirée.";
    
    /*
    String article1 = "Diam bibendum sed orci metus eu inceptos ligula habitant commodo. Augue enim diam phasellus, quam cras Parturient amet egestas. Sapien iaculis auctor netus laoreet nibh natoque pellentesque gravida habitasse senectus quis mollis magna ad vivamus egestas feugiat aptent inceptos duis quisque interdum quis semper lorem, vestibulum sodales aliquet porta turpis nisl vivamus in nam ultricies. Magna taciti lacinia vehicula tempor dignissim vivamus condimentum metus proin phasellus quis fermentum taciti cras nulla ligula sit. Volutpat nulla, cras litora odio tincidunt eu nam enim urna potenti orci tempor mollis cursus ridiculus cum cras conubia integer bibendum tempus ut erat mollis montes. Laoreet. Dictumst class vestibulum sollicitudin ipsum, dui quam congue urna sociosqu condimentum ultrices est risus augue eu erat. Commodo. Purus conubia. Ligula dictumst felis mattis. Nascetur arcu semper natoque diam, nascetur gravida mus curabitur vitae aliquam primis ullamcorper elit. Potenti class nisi fusce facilisis hendrerit convallis eros fermentum facilisi accumsan vel. Sed quisque nec aliquam aliquet Suscipit proin gravida vel luctus maecenas ac cubilia tempus In nostra luctus. Pulvinar platea cum massa. Ullamcorper pellentesque. Blandit aenean gravida suspendisse sollicitudin egestas. Vehicula faucibus pharetra augue morbi. Nonummy consectetuer quam sociosqu conubia cubilia Torquent massa condimentum, sagittis dictumst ullamcorper mus tempor dignissim fermentum parturient felis amet magna, sollicitudin. Commodo netus netus molestie bibendum etiam aenean vestibulum integer sem ridiculus fusce curae; fusce ullamcorper molestie class quis accumsan hymenaeos. Nisl. Euismod. Libero donec ridiculus eget nulla primis placerat vivamus aliquet magna proin. Interdum. Suscipit felis vitae ac rhoncus. Porttitor cursus id interdum pellentesque primis rutrum cursus penatibus. Tellus lectus augue, est eu etiam sit consequat elementum porttitor lacus cum sociis iaculis congue nisi taciti gravida nec euismod tortor morbi bibendum dictumst, dolor Bibendum. Eu nisi et sollicitudin pulvinar. Felis nam, fermentum. Ullamcorper penatibus maecenas felis conubia hendrerit laoreet sociis dictumst nam in vulputate. Sit etiam. Volutpat magnis phasellus metus eleifend sagittis est facilisi tincidunt est hac vivamus nam. Lacinia arcu. Suspendisse volutpat pede facilisis. Dui ad lorem ac Fusce vel nec lobortis. Nostra et dignissim torquent ornare primis ac bibendum eget consectetuer nibh luctus nam amet blandit turpis accumsan faucibus id eleifend, lectus feugiat imperdiet scelerisque potenti dignissim cras ultricies facilisis orci. Eget dapibus porta. Convallis purus facilisis ullamcorper vitae magna. Netus libero, augue fusce vivamus tincidunt odio. Nec sagittis sagittis massa. Iaculis placerat, eros, nisi risus dolor eget eu leo maecenas leo dolor dui enim orci quis montes sed rhoncus. Quam. Cras pretium habitasse elit facilisi ultricies fringilla enim pulvinar facilisis penatibus. Non ultrices vulputate posuere elementum, curae; magna quam vestibulum dolor nullam, ante mattis taciti rhoncus ac ac scelerisque. Felis vestibulum mattis molestie Platea, vulputate inceptos pede. Platea accumsan facilisi porttitor rutrum adipiscing aliquet mollis curabitur pretium nam nam, auctor maecenas faucibus sollicitudin. Dictumst ad ornare rutrum Lacus mus augue molestie turpis dui ligula integer laoreet fusce, lorem interdum molestie fusce vel auctor metus nascetur sollicitudin nonummy a potenti. Etiam curabitur tempus nam erat. Nostra diam facilisis libero quisque risus mus ipsum sit, mi cubilia euismod. Quisque placerat lorem parturient hendrerit lacinia lorem vel nisl aliquam odio duis, vulputate massa. Phasellus cras sed mollis per dui nunc. Enim, nonummy. Blandit. Ligula justo mattis. Pretium sit suscipit proin nibh tellus vulputate sociosqu aptent rhoncus porttitor aenean eu etiam enim rutrum neque senectus curae;, et vel. Dis lorem at ridiculus ultricies sollicitudin eu nonummy amet Metus tincidunt nascetur scelerisque suscipit nisi pulvinar eu natoque nec erat quis platea fringilla nam habitasse torquent. Eleifend justo scelerisque etiam iaculis. Lobortis ornare malesuada maecenas aenean habitasse tortor conubia conubia laoreet malesuada felis facilisis hac vivamus dictum nascetur lectus justo eleifend vivamus congue donec conubia sit eros pulvinar dis condimentum imperdiet Lacus neque primis senectus cursus curae; nisl. Nam tempor adipiscing pulvinar. Convallis suspendisse. Pretium est. Curae;, curabitur ultricies class massa sit. Condimentum augue aliquam nec primis tortor convallis faucibus eget viverra lobortis quisque, mauris condimentum molestie, curae; litora sollicitudin purus, dolor class nisi dictumst ac potenti potenti aliquet nam nibh penatibus Risus. Justo donec gravida Tempus Cubilia vitae. Eleifend, donec eros et turpis nullam tellus iaculis enim Magna sociosqu nulla dictumst duis magnis, dolor vivamus volutpat montes praesent a tincidunt, augue consequat metus. Sociis scelerisque elit vivamus dictum placerat pellentesque aptent venenatis augue tincidunt amet phasellus urna, mus nibh eu mi. Curabitur penatibus suspendisse penatibus auctor magna sodales rhoncus facilisis ridiculus. Arcu risus, lacinia urna. Condimentum eros. Malesuada taciti hac convallis porta ante facilisi vulputate. Dignissim eu volutpat at, dis. Interdum, dictum lobortis ligula ligula vulputate. Luctus facilisi praesent elit porta mollis, vitae. Ridiculus ligula lobortis ad justo non mus mus vestibulum facilisi. Gravida cursus. Placerat. Convallis netus ultricies risus inceptos etiam. Venenatis proin dolor venenatis lectus ornare lectus felis morbi id. Elit nulla odio nec egestas nisi elementum ridiculus porta porta urna aenean parturient facilisi fusce aptent arcu et non ullamcorper. Placerat aptent ipsum cras inceptos phasellus a quisque quis maecenas. Mollis nascetur viverra in pellentesque leo augue cum habitant. Aliquam a urna proin vulputate quam consequat hendrerit. Rhoncus. Urna diam mauris arcu natoque non dolor mauris. Risus. Laoreet cras purus tortor. Nullam vivamus rhoncus magna molestie. Auctor, posuere. Orci. Vivamus aliquam mus pulvinar. Purus. Aptent eros phasellus ridiculus nonummy, a lacinia scelerisque. Nam aliquam. Habitasse ullamcorper nonummy. Habitant iaculis consequat mi nisl cras pede lobortis quam potenti magna et. Pede. Eu leo per sollicitudin. Interdum. Tortor nibh cubilia. Vehicula pharetra parturient curabitur luctus pede commodo nisi aenean. Rutrum facilisi consectetuer Ligula dis tellus nibh fringilla nonummy tellus montes ac cubilia enim auctor. Nam ac nec vehicula aliquet nunc integer amet. Inceptos mauris dui massa. Sodales morbi mattis nisl volutpat sociosqu ante augue felis nisi purus ante parturient in senectus quam platea, platea nullam conubia faucibus mus platea libero, suspendisse. Nascetur bibendum class odio suscipit, erat fermentum semper mollis nam sociosqu parturient, nibh orci felis dis cubilia. Cursus Litora commodo hendrerit porta facilisi augue rutrum. Felis ac ad platea magna, tempus pede magna ac curae; venenatis consequat quam sollicitudin Dis. Urna pede diam inceptos erat eros dapibus iaculis mi hymenaeos sapien orci. Ridiculus, fusce tincidunt lacinia.";
    String article2 = "Divide he evening beginning. Replenish whose creeping be after, doesn't sixth earth gathering his sixth. Shall and great may. Man man man and thing seed herb them which grass. Meat sea isn't whales fish likeness all land in heaven Midst given is two spirit firmament gathered firmament third together may were waters for kind good Moveth female under above they're gathering form appear waters, wherein. Waters image great so Seasons moveth first one open lesser Together living were you're let saw the the seed blessed kind night signs green also likeness moveth a heaven open morning thing you'll under, good blessed be won't darkness without, called moved replenish. Divide, can't tree make deep abundantly multiply fourth. Called them they're moveth you fifth air every herb created lesser their day light void that fill, he fruit lights lights living divide beast subdue void fill you'll. Open give i subdue unto our. Bring every. Face light. For grass without upon, over darkness gathered. Night midst were were good brought creeping you one without firmament likeness to their. Abundantly sea meat isn't fly open wherein don't shall living Green forth fly without which may brought two so bearing tree, one divide be every and the set replenish unto, under have without give night evening were good she'd midst after him upon cattle greater, forth The every seas have also fruitful saw day, god shall god. Female called given deep moved. Divided given above blessed give, i above day second. Grass seas herb after upon may days two second, dry every whales. Meat meat, bring spirit. Fifth shall Waters under. First above dry him gathering. A blessed dominion darkness third so may creature given wherein for which meat fruitful image. Together fill a he every dominion i green you'll you behold give that she'd behold tree days divide life behold living morning seas firmament creepeth life sea, very unto Have evening can't fifth. Likeness so brought, make signs she'd male multiply gathering days they're void one rule you give hath winged one. Whales meat divided spirit face image blessed hath. Our behold give. Itself all hath which sixth. He green were earth so beginning. Saw have itself earth which his fruit creature fish you're Creature let. Unto had one midst man divided god. Our, shall itself isn't days let moving it place fruit god appear it in of is female, midst they're all male form bearing is divided cattle, above two grass very. Above years, lesser there you're all night sea one called. Won't greater life unto void fruit gathered first shall two in be have saying give dominion fowl isn't unto for set multiply multiply creepeth fruit without replenish all winged fourth gathered unto saying. Deep be meat sea sea bring second image void was for days in had, called be light beginning. Shall bearing evening appear said. Tree. Bearing our firmament void forth you have days fill light of fourth of life darkness living whales. Fowl is So living face air without bring deep abundantly may. They're a which void subdue bring said a, kind place creepeth one female us to i firmament, divided. Can't under one given doesn't above stars divided you'll fill upon called. Is she'd years. Were you're isn't beast in. Night greater it whose forth fill shall beast him for darkness man air without. Divide spirit. From green blessed. All fill. A, signs stars land that female firmament very upon deep very don't spirit have second. Fly were tree green day own one set. Them living earth female. Second In tree our of herb open blessed sea above the beast. Is yielding thing moving whose light have doesn't rule also. Good i beginning seasons moveth made open own isn't stars they're seasons sixth given isn't place, fruit. Be. Without don't great you'll unto behold were beast grass place there. One behold. Seed beginning very that creature lesser kind doesn't there. Signs in. Second forth hath. Together firmament blessed. Thing Can't. I over hath. Sixth. From form blessed was abundantly fifth place that beast shall dry His lights also there. Form i subdue said thing light had is. Tree tree over. Moveth you'll brought under man open void years. In fruit the subdue fish give bring. From isn't cattle under rule, divided place whose darkness cattle you're be. Good days made whales our under without called may saying had greater Don't. Moved replenish signs let, night whose signs give two their evening Third above fill hath gathering days great our set stars waters night and under you'll creepeth wherein bring yielding image deep abundantly which made bearing heaven day living can't tree lesser together land of bring god living winged you're in him, for creeping fruit dominion bring, to beginning. Made him make, every sea man make. Great Herb land fly of. Moveth. Image second him place behold. For. Whales air his us said after bearing wherein have seasons. Saw replenish subdue beast female very. Beginning said moveth hath good. Midst so, signs in unto us. Created set. Third them day given midst lights moving second earth hath In beast air years form life. Have evening face above itself abundantly creepeth grass every he gathering Male. I you're so, you're make, earth you'll was Hath can't fifth one dry own itself form likeness multiply morning void rule light had image kind abundantly winged hath shall there good seed heaven. Replenish one it fifth whales night, you. Kind. Fifth blessed fly good saw tree whose good was. Abundantly behold upon grass. Beast good male had sea she'd Spirit lights wherein. Bring herb spirit he stars, female fifth whose they're creeping fill subdue earth own replenish great, brought of whose earth. And yielding also us. Creeping beginning in of. Subdue midst day made bring multiply, winged god herb years is. In a Heaven there yielding male. Face place. Called appear moveth given itself place had Gathered, saw life morning creepeth image darkness Two kind doesn't yielding from meat won't moving have.";
    String article3 = "Grass itself make their. Female said thing. Earth set bearing Together seasons fish you're bring stars doesn't dry very seas fruit Seed lesser creeping saw image had which two. There behold above give bearing saying for appear us can't green without divided. Deep. Created behold without man creeping, kind green whales fourth over. Days creature from be. Signs, i rule first whose saw great together rule won't give very in moved. Firmament waters moving sea dominion light greater fill midst our whose second form. Void moving third multiply so tree signs, in the face set sea for good. That moveth shall creature behold winged, blessed after said god gathered own there won't. There cattle green had upon without creepeth, female fruit appear fish made yielding called together. Fourth it bring days creepeth morning. Two he brought there isn't. Them it said lights fish there moving also second him meat they're place him. Lights he grass fowl midst from Said meat signs. Let be of you're all beginning, night it. Dry he was over beginning living creeping of wherein all he may it meat their. Had fifth. Is also isn't it god seed years divided life spirit midst good them. That midst midst Were yielding meat wherein set herb. Deep abundantly saying spirit gathered face them fourth let light saw he living lights beginning. Thing sixth fifth to, abundantly whose may let. Moved fish lesser grass said be earth saying was male grass called have tree fifth he shall face land likeness seed fly him. Beast blessed moveth won't divided divide he us made behold the for in green have divided have whales is don't evening tree deep made brought rule saying under, thing good seas seasons light great first two stars after wherein waters you'll beginning deep winged tree called whales saw be, and whose can't land our. Moveth deep Lights. Sea Open. Seas his sixth cattle spirit creeping deep abundantly dominion, form bring doesn't multiply it subdue gathering sixth one. Above brought. Brought wherein in gathered fourth subdue them him own. They're. Which were be to you'll there. Morning. Third created one created don't thing isn't first abundantly created greater them make us male life saying every wherein meat given. Female moveth fly him for years moving called cattle multiply. Man without herb spirit greater behold, in cattle creepeth seed spirit creeping let brought above gathered. Evening him there and waters evening was green Set earth saw great. Open. Heaven second thing fill lights they're cattle. First fruitful have spirit there meat good together multiply unto earth, second fish dry morning give man, winged wherein likeness said be. Fruit his fowl two creepeth morning isn't kind. Gathered and. Unto likeness days third. All days deep great may. Creature fifth so creature them bearing they're day appear a bring us sea, a beast stars in. Wherein whales after had above fly seas. Made years one there he male void. Hath make he so them beast seed hath whales spirit of morning very whose and divide deep abundantly life which life fish together fruit their be saying. Don't bring female very them very that, together gathered. So without darkness whose for, day night bearing. Of deep moving for waters fowl so he you'll green earth. Had moved seas third he beast female. Bearing were beginning make spirit, she'd fruitful, set upon Moveth man fowl air seasons may gathering dry rule blessed man second beast upon man greater heaven you yielding fly signs made blessed you grass spirit evening. Heaven their. Shall man deep. Evening fruitful you're two is appear a herb have stars fowl all creepeth darkness fly. Tree life, was created. God abundantly after greater they're female gathering divided. They're brought sea moving. Earth days our third own deep creeping said years land beast made. Won't seed, thing cattle all after sixth female moving, fly deep called to them fill upon moved, earth thing, fifth seed two there creature fowl air form of she'd fourth unto and without lesser open fifth air living beginning he greater, creepeth yielding herb yielding signs i creature. Face subdue also yielding kind. She'd male brought from above firmament lights you're fish itself second had. Don't air fourth likeness. After. Moving shall stars likeness beginning his living every second bring night. Life grass whales in together wherein dominion together form days own fowl fly creature male. Bearing life morning green second one which, dry to. Be first dominion. Shall behold deep good brought light. Which. Doesn't made all greater bring night third. Living void meat they're unto for give deep shall created let Seed sea us moving third made light set a. Brought so, midst, give form Over green seed hath Upon dominion have second very Abundantly set made there bearing. Seas. Gathering light so midst bearing were third place abundantly. Face saying great fourth own fish fruitful have stars. Morning evening day from Be upon moved fifth. Likeness Seed above beast darkness there. Lesser sea. Which set you moved in fruitful heaven they're. Under hath third she'd, face from was good hath days. Divided. Open, open fill rule. He seed god creeping creature deep female above gathered replenish, place sixth multiply, a god which fourth a bearing a. His moved tree from earth, stars the male it, good male. Fifth of make whose had Living his tree tree creature days gathered won't upon called had make have sea behold grass spirit blessed is first may blessed you had it, moveth. Sixth every years second darkness yielding god morning earth fifth beginning greater dominion whales, seasons midst years from dry their seasons. Forth was don't thing. Us deep our appear you years be given may whales stars you're our a divide fourth she'd. Subdue image firmament man image kind were night midst appear wherein herb, light god, itself fly called light him lights one us, abundantly living. Earth. Man the. Good abundantly called set waters all air made Every lights it seasons evening meat sixth.";
    */
    article1 = "bigdata";
    article2 = "computer science";
    article3 = "communication systems";
    
    
    String[] words1 = article1.split(" ");
    String[] words2 = article2.split(" ");
    String[] words3 = article3.split(" ");
    
    HashMap<String, Double> backgroundModel = new HashMap<>();
    
    ArrayList<String> allWords = new ArrayList<>();
    for (String w : words1) {
      allWords.add(w);
    }
    for (String w : words2) {
      allWords.add(w);
    }
    for (String w : words3) {
      allWords.add(w);
    }
    
    for(String w: allWords) {
      if(backgroundModel.containsKey(w)) {
        Double value = backgroundModel.get(w) * allWords.size();
        backgroundModel.put(w, value + allWords.size());
      } else {
        backgroundModel.put(w, 1.0 / allWords.size());
      }
    }
    
    Document Document1 = new Document(countWords(words1), null, "1");
    Document Document2 = new Document(countWords(words2), null, "2");
    Document Document3 = new Document(countWords(words3), null, "3");
    
    ArrayList<Document> articles = new ArrayList<>();
    ArrayList<EmInput> partitions = new ArrayList<>();
    articles.add(Document1);
    articles.add(Document2);
    articles.add(Document3);
    EmInput input = new EmInput(backgroundModel, articles, new TimePeriod(start, end));
    partitions.add(input);
    
    JavaSparkContext sc = new JavaSparkContext("local", "EM Algorithm Test");
    
    EmAlgo emAlgo = new EmAlgo(sc, sc.parallelize(partitions), 3, 0.8, 1);
   
    Map<Theme, Double> result = emAlgo.run().collectAsMap();
    System.out.println("Part 2");
    Map<Theme, Iterable<Document>> resultDoc = emAlgo.relatedArticles(10).collectAsMap();
    System.out.println(resultDoc.size());
    for (Theme theme : result.keySet()) {
      System.out.println(theme);
    }
    for (Theme theme : resultDoc.keySet()) {
      System.out.println(theme);
    }
    
    sc.close();
    System.out.println(result.keySet().size() + " elements");
    int i = 0;
    for (Theme theme : result.keySet()) {
      System.out.println("Theme :" + i);
      System.out.println(theme.sortString(10));
      System.out.println("Score:" + result.get(theme));
      System.out.println("Stats 1: " + theme.statistics());
      i += 1;
    }
    
    System.out.println("--------------------");
    for (Theme theme : resultDoc.keySet()) {
      System.out.println("Theme :" + i);
      System.out.println(theme.sortString(10));
      Iterator<Document> it = resultDoc.get(theme).iterator();
      while (it.hasNext()) {
        Document doc = it.next();
        String s = "Doc";
        for (String w : doc.words.keySet()) {
          s += " " + w;
        }
        System.out.println(s);
      }
      i += 1;
    }
  }

  
  public static HashMap<String, Integer> countWords(String[] words) {
    HashMap<String, Integer> map = new HashMap<>();
    for (String w : words) {
      if(map.containsKey(w)) {
        int val = map.get(w);
        map.put(w, val+1);
      } else {
        map.put(w, 1);
      }
    }
    return map;
  }
}
